{% extends 'base.html' %}

{% block content %}
<!-- KPI Cards -->
<div class="row mb-4">
    {% for status, count in status_counts.items() %}
    <div class="col-md-2 mb-3">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body text-center p-3">
                <h6 class="text-muted text-uppercase small mb-2">{{ status }}</h6>
                <h3 class="mb-0 fw-bold text-primary">{{ count }}</h3>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm border-0">
            <div class="card-body bg-light-blue">
                <form method="GET" action="{{ url_for('index') }}" class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="search" class="form-label">Keresés (Név / Fejlesztő / Igénylő)</label>
                        <input type="text" class="form-control" id="search" name="search" value="{{ search }}" placeholder="Projekt neve...">
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">Státusz</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">Mind</option>
                            {% for s in statuses %}
                                <option value="{{ s }}" {% if status_filter == s %}selected{% endif %}>{{ s }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="missing_docs" name="missing_docs" {% if missing_docs == 'on' %}checked{% endif %}>
                            <label class="form-check-label" for="missing_docs">
                                Hiányzó dokumentumok
                            </label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter"></i> Szűrés</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="card shadow border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-primary text-white">
                    <tr>
                        <th>Projekt Neve / Leírás</th>
                        <th>Fejlesztő / Igénylő</th>
                        <th>Státusz</th>
                        <th>Beérkezés / Vége</th>
                        <th>Készültség</th>
                        <th>FTE</th>
                        <th>Dokumentumok</th>
                        <th class="text-end">Műveletek</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr class="project-row">
                        <td>
                            <div class="fw-bold">{{ project.project_name }}</div>
                            {% if project.description %}
                            <div class="text-muted small text-truncate" style="max-width: 200px;" title="{{ project.description }}">
                                {{ project.description }}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-bold">{{ project.developer_name }}</div>
                            <div class="text-muted small"><i class="fas fa-user-tag me-1"></i>{{ project.requestor }}</div>
                        </td>
                        <td>
                            <span class="badge rounded-pill
                                {% if project.status == 'Új' %}bg-secondary
                                {% elif project.status == 'Folyamatban' %}bg-primary
                                {% elif project.status == 'Tesztelés' %}bg-warning text-dark
                                {% elif project.status == 'Kész' %}bg-success
                                {% elif project.status == 'Élesítve' %}bg-info text-dark
                                {% else %}bg-dark{% endif %}">
                                {{ project.status }}
                            </span>
                        </td>
                        <td>
                            <div><small class="text-muted">Start:</small> {{ project.arrival_date.strftime('%Y-%m-%d') }}</div>
                            {% if project.end_date %}
                                <div><small class="text-muted">Vége:</small> {{ project.end_date.strftime('%Y-%m-%d') }}</div>
                            {% else %}
                                <div class="text-muted">-</div>
                            {% endif %}
                        </td>
                        <td style="width: 15%;">
                            <div class="d-flex align-items-center">
                                <span class="me-2">{{ project.percentage }}%</span>
                                <div class="progress flex-grow-1" style="height: 6px;">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ project.percentage }}%;" aria-valuenow="{{ project.percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if project.fte %}
                                <span class="badge bg-light text-dark border">{{ project.fte }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                                <!-- Business Doc -->
                                {% if project.doc_business %}
                                    <a href="{{ url_for('uploaded_file', filename=project.doc_business) }}" class="doc-icon has-doc" title="Üzleti igény: {{ project.doc_business }}" target="_blank">
                                        <i class="fas fa-file-contract"></i>
                                    </a>
                                {% else %}
                                    <span class="doc-icon missing-doc" title="Hiányzó Üzleti Igény"><i class="fas fa-file-contract"></i></span>
                                {% endif %}

                                <!-- Test Doc -->
                                {% if project.doc_test %}
                                    <a href="{{ url_for('uploaded_file', filename=project.doc_test) }}" class="doc-icon has-doc" title="Tesztjegyzőkönyv: {{ project.doc_test }}" target="_blank">
                                        <i class="fas fa-file-circle-check"></i>
                                    </a>
                                {% else %}
                                    <span class="doc-icon missing-doc" title="Hiányzó Tesztjegyzőkönyv"><i class="fas fa-file-circle-check"></i></span>
                                {% endif %}

                                <!-- Ops Doc -->
                                {% if project.doc_ops %}
                                    <a href="{{ url_for('uploaded_file', filename=project.doc_ops) }}" class="doc-icon has-doc" title="Üzemeltetési doksi: {{ project.doc_ops }}" target="_blank">
                                        <i class="fas fa-server"></i>
                                    </a>
                                {% else %}
                                    <span class="doc-icon missing-doc" title="Hiányzó Üzemeltetési doksi"><i class="fas fa-server"></i></span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-end">
                            <a href="{{ url_for('edit', id=project.id) }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></a>
                            <form action="{{ url_for('delete', id=project.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Biztosan törölni szeretnéd?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">Nincs megjeleníthető projekt.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
